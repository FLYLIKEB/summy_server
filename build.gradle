buildscript {
    repositories {
        mavenCentral()
    }
}

plugins {
    id 'java'
    id 'org.springframework.boot' version '3.4.4' apply false
    id 'io.spring.dependency-management' version '1.1.7' apply false
}

allprojects {
    group = 'com.jwp'
    version = '0.0.1-SNAPSHOT'

    repositories {
        mavenCentral()
    }
}

subprojects {
    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    
    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(21)
        }
    }
    
    configurations {
        compileOnly {
            extendsFrom annotationProcessor
        }
    }
    
    dependencies {
        // Spring Boot
        implementation 'org.springframework.boot:spring-boot-starter'
        
        // Lombok
        compileOnly 'org.projectlombok:lombok'
        annotationProcessor 'org.projectlombok:lombok'
        testCompileOnly 'org.projectlombok:lombok'
        testAnnotationProcessor 'org.projectlombok:lombok'
        
        // Bean Validation
        implementation 'org.springframework.boot:spring-boot-starter-validation'
        
        // Test
        testImplementation 'org.springframework.boot:spring-boot-starter-test'
    }
    
    tasks.named('test') {
        useJUnitPlatform()
    }
}

// core 모듈 관련 설정
project(':core') {
    dependencies {
        // JPA
        implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
        
        // Redis
        implementation 'org.springframework.boot:spring-boot-starter-data-redis'
        
        // Flyway
        implementation 'org.flywaydb:flyway-core'
        implementation 'org.flywaydb:flyway-mysql'
        
        // QueryDsl - Spring Boot 3.x 호환 버전
        implementation 'com.querydsl:querydsl-jpa:5.0.0:jakarta'
        annotationProcessor 'com.querydsl:querydsl-apt:5.0.0:jakarta'
        annotationProcessor 'jakarta.annotation:jakarta.annotation-api'
        annotationProcessor 'jakarta.persistence:jakarta.persistence-api'
        
        // 테스트용 인메모리 DB
        runtimeOnly 'com.h2database:h2'
        // 운영용 DB 드라이버
        runtimeOnly 'org.mariadb.jdbc:mariadb-java-client'
    }
    
    // Q클래스 생성 설정
    def querydslDir = "$buildDir/generated/querydsl"
    
    tasks.register('generateQuerydsl', JavaCompile) {
        source = sourceSets.main.java
        classpath = configurations.compileClasspath
        options.annotationProcessorPath = configurations.annotationProcessor
        options.generatedSourceOutputDirectory = file(querydslDir)
    }
    
    sourceSets {
        main.java.srcDir querydslDir
    }
    
    tasks.named('compileJava') {
        dependsOn 'generateQuerydsl'
    }
}

// api 모듈 관련 설정
project(':api') {
    dependencies {
        implementation project(':core')
        
        // Web
        implementation 'org.springframework.boot:spring-boot-starter-web'
        
        // Security
        implementation 'org.springframework.boot:spring-boot-starter-security'
    }
}
